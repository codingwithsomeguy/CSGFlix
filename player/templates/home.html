<html>
<head>
<title>player</title>
</head>
<body>
<canvas id="canvas" width="426" height="240" style="background-color:black">
</canvas>

<br><br>

<canvas id="deltacanvas" width="426" height="240" style="background-color:black">
</canvas>



<script>
const w = 426;  const h = 240;

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const offcanvas = new OffscreenCanvas(w, h);
const offCtx = offcanvas.getContext("2d");

ctx.clearRect(0, 0, w, h);
offCtx.clearRect(0, 0, w, h);


function showImageArray(useThisContext, imgArray) {
    const iData = offCtx.createImageData(w, h);
    for (let i = 0, j = 0; i < imgArray.length; ++i) {
        if ((i % 4) == 3) { // A
            iData.data[i] = 255;
        } else {    // R G B
            iData.data[i] = (imgArray[j]<<1);
            j += 1;
        }
    }

    //console.log(iData);
    useThisContext.putImageData(iData, 0, 0);
}

function showImageArrayDelta(imgArrayI1, imgArrayDelta) {
    const deltaCanvas = document.getElementById("deltacanvas");
    const deltaCtx = deltaCanvas.getContext("2d");

    showImageArray(deltaCtx, imgArrayDelta);

    const iData = offCtx.createImageData(w, h);
    for (let i = 0, j = 0; i < imgArrayI1.length; ++i) {
        if ((i % 4) == 3) { // A
            iData.data[i] = 255;
        } else {    // R G B
            iData.data[i] = imgArrayI1[j] ^ imgArrayDelta[j];
            j += 1;
        }
    }

    //console.log(iData);
    ctx.putImageData(iData, 0, 0);
}



let i = 1;
function doTheVideo() {
    const videoTimer = setInterval(function () {
            fetch(`/imga/${i}`).then(x => x.json()).then(x => showImageArray(ctx, x));
            i += 1;
            if (i >= 900) {
                clearInterval(videoTimer);
            }
        }, 33);
}

function rle_decode(arr) {
    // [3 17 3 8...] --> [17 17 17 8 8 8...]
    const result = [];
    for (let i = 0 ; i < arr.length ; i = i + 2) {
        const repetition_count = arr[i];
        const symbol = arr[i+1];
        for (let j = 0 ; j < repetition_count ; ++j) {
            result.push(symbol);
        }
    }

    return result;
}

fetch(`/imga/123`).then(x => x.json()).then(function (i1) {
    showImageArray(ctx, rle_decode(i1));
    //fetch(`/imgad/900`).then(x => x.json()).then(i2d => showImageArrayDelta(i1, i2d));
});

function doTheAudio() {
    fetch("/a").then(x => x.json()).then(function (x) {
        const aCtx = new window.AudioContext();
        const buf = aCtx.createBuffer(1, x.length, 8000);
        const bufChan = buf.getChannelData(0);
        for (let i = 0; i < x.length; ++i) {
            bufChan[i] = (x[i] - 128) / 128.0;
        }

        const bufSource = aCtx.createBufferSource();
        bufSource.buffer = buf;
        bufSource.connect(aCtx.destination);
        bufSource.start();

        doTheVideo();
    });
}

//doTheAudio();

</script>
<button onclick="doTheAudio()">Play Button</button>
</body>
</html>
